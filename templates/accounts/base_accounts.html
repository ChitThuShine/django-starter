
{% extends 'base.html'%} 
{% load static %}
{% block head_css %} {{ block.super}}
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.datatables.net/1.11.1/css/jquery.dataTables.css"
/>
<link
  href="{% static '/styles/pivottable.css' %}"
  rel="stylesheet"
/>
<link
  href="https://cdn.webdatarocks.com/latest/webdatarocks.min.css"
  rel="stylesheet"
/>

{%endblock%} {% block page_content %}
<div x-data="accounts()" class="flex flex-col p-4 lg:p-6">
  <div class="flex flex-row justify-between">
    <div class="text-sm breadcrumbs">
      <ul>
        <li>
          <a><h1 class="text-4xl font-bold my-2">Accounts</h1></a>
        </li>
        <li x-show="currentPage.id !== 1">
          <a>
            <h1 class="text-4xl font-bold my-2" x-text="currentPage.name"></h1
          ></a>
        </li>
      </ul>
    </div>

    <div x-cloak class="flex flex-row items-center">
      <div class="btn-group mr-3" x-show="currentPage.id !== 1">
        <button
          class="btn btn-xs lg:btn-sm btn-primary btn-outline"
          :class="currentPage.view== 'table' && 'btn-active' "
          @click="currentPage.view= 'table'"
        >
          table
        </button>
        <button
          class="btn btn-xs lg:btn-sm btn-primary btn-outline"
          :class="currentPage.view== 'charts' && 'btn-active' "
          @click="currentPage.view= 'charts'"
        >
          charts
        </button>
      </div>
      <button
        class="btn btn-xs lg:btn-sm"
        x-show="currentPage.id !== 1"
        @click="switchPage('home')"
      >
        Back
      </button>
    </div>
  </div>

  <div x-cloak x-show="currentPage.id===1" class="flex mt-10">
    <div class="w-1/3 xl:w-1/5 mr-10 card shadow lg:card-side bg-white">
      <div @click="switchPage('sales')" class="card-body">
        <h1 class="leading">Sales</h1>
        <div class="justify-end card-actions">
          <button class="btn btn-ghost shadow">
            Go
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              class="inline-block w-6 h-6 ml-2 stroke-current"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
    <div class="w-1/3 xl:w-1/5 mr-10 card shadow lg:card-side bg-white">
      <div @click="switchPage('costs')" class="card-body">
        <h1 class="leading">Costs</h1>
        <div class="justify-end card-actions">
          <button class="btn btn-ghost shadow">
            Go
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              class="inline-block w-6 h-6 ml-2 stroke-current"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
    <div
      class="w-1/3 xl:w-1/5 mr-1- card text-center shadow lg:card-side bg-white"
    >
      <div @click="switchPage('profit_loss')" class="card-body">
        <h1 class="leading">Profits Losss</h1>
        <div class="justify-end card-actions">
          <button class="btn btn-ghost shadow">
            Go
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              class="inline-block w-6 h-6 ml-2 stroke-current"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div x-cloak x-show="currentPage.id=== 2">
    {% include "accounts/pages/sales.html" %}
  </div>
</div>

{% endblock %} {% block footer_js %} {{block.super}}
<script>
  const accountPages = {
    home: { name: "home", id: 1 },
    sales: {
      name: "Sales",
      id: 2,
      view:"table"
    },
    costs: {
       name: "Costs",
      id: 3 ,
      view:'table'
    },
    profit_loss: { name: "P&L", id: 4 },
  };
  function accounts() {
    return {
      currentPage: accountPages["home"],
      currentView: "table",
      pages: accountPages,
      ui: {
        salesPivotLoaded: false,
      },
      data: {
        dailySales: [],
      },
      switchPage(key) {
        try {
          this.currentPage = this.pages[key];
          let salesData;
          if (this.currentPage.id === 2 && !this.ui.salesPivotLoaded) {
            console.log("fetch daily sales");
            $.get("/api/accounts/accounts/dailysales", function (data) {
              console.log(data);
              salesData = data;
              return createWebDataRocks(data);
            });
            this.data.dailySales = salesData;
          }
        } catch (e) {
          console.log(e);
        }
      },
    };
  }

  let pivot;

  const dailySales = [{
    "Product": {
        type: "level",
        hierarchy: "Product"
    },
    "Date": {
        type: "level",
        hierarchy: "Product",
        level: "Date sold",
        parent: "Product"
    },
    "Sold":{
       type: "number",
    },
    "Total":{
       type: "number",
    },
    "Add":{
       type: "number",
    },
    "Close":{
       type: "number",
    },
    "Open":{
       type: "number",
    }
  }]
  
  function createWebDataRocks(data) {
    pivot = new WebDataRocks({
      container: "#wdr-component",
      toolbar: true,
      report: {
        dataSource: {
          dataSourceType: "json",
          data: getJSONData(data),
        },
        slice: {
          reportFilters: [{
                uniqueName: "Product"
            }
         ],
          rows: [
            {
              uniqueName: "Date"
            },
            {
              uniqueName: "Product",
            },
          ],
          columns: [
            {
              uniqueName: "Measures",
            },
          ],
          measures: [
            {
              uniqueName: "Sold",
              name:"Sold",
              aggregation: "sum",
            },
            {
                "uniqueName": "Sold * Price",
                "formula": "sum(\"Price\") * sum(\"Sold\") ",
                "individual": true,
                "caption": "Overall Sold Value (Sold x Price)",
                "format": "currency"
            }
          ],
        },
      },
      reportcomplete: function () {
        pivot.off("reportcomplete");
        createChart();
      },
    });
  }

  function getJSONData(data) {
    return dailySales.concat(data)
  }

  function createChart() {
    pivot.highcharts.getData(
      {
        type: "column",//"areaspline",
      },
      function (data) {
        Highcharts.chart("highchartsContainer", data);
      },
      function (data) {
        Highcharts.chart("highchartsContainer", data);
      }
    );
  }
</script>

<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"
></script>

<script src="https://cdn.webdatarocks.com/latest/webdatarocks.toolbar.min.js"></script>
<script src="https://cdn.webdatarocks.com/latest/webdatarocks.js"></script>
<script src="https://code.highcharts.com/4.2.2/highcharts.js"></script>
<script src="https://code.highcharts.com/4.2.2/highcharts-more.js"></script>
<script src="https://cdn.webdatarocks.com/latest/webdatarocks.highcharts.js"></script>

<script>
  $(document).ready(function () {});
</script>
{% endblock %}
